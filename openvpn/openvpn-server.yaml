AWSTemplateFormatVersion: '2010-09-09'
Description: OpenVPN Server EC2 Instance with automated setup

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair for SSH access
    Default: course-site

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t4g.micro
      - t4g.small
      - t4g.medium
    Description: EC2 instance type for OpenVPN server

  VPNPort:
    Type: Number
    Default: 1194
    Description: UDP port for OpenVPN connections
    MinValue: 1024
    MaxValue: 65535

  ClientSubnet:
    Type: String
    Default: 10.8.0.0/24
    Description: Subnet for VPN clients (CIDR notation)
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$'

  AllowedCIDR:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR block allowed to connect to OpenVPN (0.0.0.0/0 for anywhere)
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$'

  ServerName:
    Type: String
    Default: openvpn-server
    Description: Name for the OpenVPN server

  AdminPassword:
    Type: String
    Default: OpenVPN123!
    Description: Password for OpenVPN admin user
    NoEcho: true
    MinLength: 8

Resources:
  # VPC for OpenVPN Server
  OpenVPNVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-VPC

  # Internet Gateway
  OpenVPNInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-IGW

  # Attach Internet Gateway
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref OpenVPNVPC
      InternetGatewayId: !Ref OpenVPNInternetGateway

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OpenVPNVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PublicSubnet

  # Private Subnets for testing VPN connectivity
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OpenVPNVPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PrivateSubnet1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OpenVPNVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PrivateSubnet2

  # NAT Gateway Elastic IP
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-NAT-EIP

  # NAT Gateway
  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-NATGateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref OpenVPNVPC
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref OpenVPNVPC
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PrivateRouteTable

  # Routes
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref OpenVPNInternetGateway

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # Subnet Route Table Associations
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # Security Group for OpenVPN Server
  OpenVPNSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for OpenVPN server
      VpcId: !Ref OpenVPNVPC
      SecurityGroupIngress:
        # OpenVPN UDP port
        - IpProtocol: udp
          FromPort: !Ref VPNPort
          ToPort: !Ref VPNPort
          CidrIp: !Ref AllowedCIDR
          Description: OpenVPN UDP traffic
        # SSH access
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCIDR
          Description: SSH access
        # HTTP for web interface
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref AllowedCIDR
          Description: HTTP Web Server
        # HTTPS for web admin (optional)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AllowedCIDR
          Description: HTTPS Web Server
      SecurityGroupEgress:
        # Allow all outbound traffic
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: All outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-SecurityGroup

  # Security Group for Private Test Instances
  PrivateInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for private test instances
      VpcId: !Ref OpenVPNVPC
      SecurityGroupIngress:
        # SSH from VPN clients and OpenVPN server
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref ClientSubnet
          Description: SSH from VPN clients
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref OpenVPNSecurityGroup
          Description: SSH from OpenVPN server
        # HTTP for testing
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref ClientSubnet
          Description: HTTP from VPN clients
        # HTTPS for testing
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref ClientSubnet
          Description: HTTPS from VPN clients
        # ICMP for ping testing
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !Ref ClientSubnet
          Description: ICMP from VPN clients
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref OpenVPNSecurityGroup
          Description: ICMP from OpenVPN server
      SecurityGroupEgress:
        # Allow all outbound traffic
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: All outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PrivateSecurityGroup

  # IAM Role for EC2 Instance
  OpenVPNRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: OpenVPNServerPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceAttribute
                  - ec2:ModifyInstanceAttribute
                Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-Role

  # Instance Profile
  OpenVPNInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref OpenVPNRole

  # Elastic IP for OpenVPN Server
  OpenVPNElasticIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-EIP

  # OpenVPN Server EC2 Instance using Community Edition
  OpenVPNServer:
    Type: AWS::EC2::Instance
    Properties:
      # Use Ubuntu 22.04 LTS AMI
      ImageId: !Sub '{{resolve:ssm:/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id}}'
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref OpenVPNInstanceProfile
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref OpenVPNSecurityGroup
      SourceDestCheck: false  # Important for VPN routing
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail
          
          # Log all output
          exec > >(tee /var/log/openvpn-setup.log) 2>&1
          
          echo "Starting OpenVPN Community Edition installation at $(date)"
          
          # Update system
          apt update -y
          DEBIAN_FRONTEND=noninteractive apt upgrade -y
          
          # Install required packages
          DEBIAN_FRONTEND=noninteractive apt install -y openvpn easy-rsa iptables-persistent nginx openssl curl
          
          # Enable IP forwarding
          echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
          sysctl -p
          
          # Create OpenVPN directory structure
          mkdir -p /etc/openvpn/server
          mkdir -p /etc/openvpn/client
          mkdir -p /var/log/openvpn
          
          # Set up Easy-RSA
          cp -r /usr/share/easy-rsa /etc/openvpn/
          cd /etc/openvpn/easy-rsa
          
          # Initialize PKI
          ./easyrsa init-pki
          
          # Create CA certificate (non-interactive)
          echo "OpenVPN-CA" | ./easyrsa build-ca nopass
          
          # Generate server certificate and key
          echo "yes" | ./easyrsa build-server-full server nopass
          
          # Generate Diffie-Hellman parameters
          ./easyrsa gen-dh
          
          # Generate TLS-auth key
          openvpn --genkey secret pki/ta.key
          
          # Copy certificates to OpenVPN directory
          cp pki/ca.crt /etc/openvpn/server/
          cp pki/issued/server.crt /etc/openvpn/server/
          cp pki/private/server.key /etc/openvpn/server/
          cp pki/dh.pem /etc/openvpn/server/
          cp pki/ta.key /etc/openvpn/server/
          
          # Create server configuration
          cat > /etc/openvpn/server/server.conf << 'EOF'
          port ${VPNPort}
          proto udp
          dev tun
          ca ca.crt
          cert server.crt
          key server.key
          dh dh.pem
          server ${ClientSubnet}
          ifconfig-pool-persist /var/log/openvpn/ipp.txt
          push "redirect-gateway def1 bypass-dhcp"
          push "dhcp-option DNS 8.8.8.8"
          push "dhcp-option DNS 8.8.4.4"
          push "route 10.0.0.0 255.255.0.0"
          keepalive 10 120
          tls-auth ta.key 0
          cipher AES-256-GCM
          auth SHA256
          user nobody
          group nobody
          persist-key
          persist-tun
          status /var/log/openvpn/status.log
          log-append /var/log/openvpn/openvpn.log
          verb 3
          explicit-exit-notify 1
          EOF
          
          # Set up iptables for NAT
          iptables -t nat -A POSTROUTING -s ${ClientSubnet} -o eth0 -j MASQUERADE
          iptables -A INPUT -i tun+ -j ACCEPT
          iptables -A FORWARD -i tun+ -j ACCEPT
          iptables -A FORWARD -i tun+ -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
          iptables -A FORWARD -i eth0 -o tun+ -m state --state RELATED,ESTABLISHED -j ACCEPT
          
          # Save iptables rules
          iptables-save > /etc/iptables/rules.v4
          systemctl enable netfilter-persistent
          
          # Enable and start OpenVPN
          systemctl enable openvpn-server@server
          systemctl start openvpn-server@server
          
          # Create client certificate generation script
          cat > /etc/openvpn/create-client.sh << 'EOF'
          #!/bin/bash
          CLIENT_NAME=$1
          if [ -z "$CLIENT_NAME" ]; then
              echo "Usage: $0 <client_name>"
              exit 1
          fi
          
          cd /etc/openvpn/easy-rsa
          ./easyrsa build-client-full $CLIENT_NAME nopass
          
          # Create client config
          mkdir -p /etc/openvpn/client/$CLIENT_NAME
          cat > /etc/openvpn/client/$CLIENT_NAME/$CLIENT_NAME.ovpn << EOL
          client
          dev tun
          proto udp
          remote ${OpenVPNElasticIP} ${VPNPort}
          resolv-retry infinite
          nobind
          persist-key
          persist-tun
          remote-cert-tls server
          cipher AES-256-GCM
          auth SHA256
          verb 3
          <ca>
          $(cat /etc/openvpn/server/ca.crt)
          </ca>
          <cert>
          $(cat /etc/openvpn/easy-rsa/pki/issued/$CLIENT_NAME.crt)
          </cert>
          <key>
          $(cat /etc/openvpn/easy-rsa/pki/private/$CLIENT_NAME.key)
          </key>
          <tls-auth>
          $(cat /etc/openvpn/server/ta.key)
          </tls-auth>
          key-direction 1
          EOL
          
          echo "Client configuration created: /etc/openvpn/client/$CLIENT_NAME/$CLIENT_NAME.ovpn"
          EOF
          
          chmod +x /etc/openvpn/create-client.sh
          
          # Create default client
          /etc/openvpn/create-client.sh client1
          
          # Set up simple web server for client download
          mkdir -p /var/www/html/clients
          cp -r /etc/openvpn/client/* /var/www/html/clients/
          
          # Create simple web interface
          cat > /var/www/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>OpenVPN Community Server</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; }
                  .download-link { background: #007cba; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>OpenVPN Community Server</h1>
                  <p>Your OpenVPN server is running successfully!</p>
                  <h2>Download Client Configuration</h2>
                  <p><a href="/clients/client1/client1.ovpn" class="download-link">Download client1.ovpn</a></p>
                  <h2>Server Information</h2>
                  <ul>
                      <li>Server IP: ${OpenVPNElasticIP}</li>
                      <li>Port: ${VPNPort} (UDP)</li>
                      <li>Client Subnet: ${ClientSubnet}</li>
                  </ul>
                  <h2>Instructions</h2>
                  <ol>
                      <li>Download the client configuration file</li>
                      <li>Install OpenVPN client on your device</li>
                      <li>Import the .ovpn file</li>
                      <li>Connect to the VPN</li>
                  </ol>
              </div>
          </body>
          </html>
          EOF
          
          # Configure nginx
          systemctl enable nginx
          systemctl start nginx
          
          # Wait for services to start
          sleep 10
          
          # Verify OpenVPN is running
          systemctl status openvpn-server@server
          
          # Create setup completion marker
          touch /tmp/openvpn-setup-complete
          
          # Log final status
          echo "OpenVPN Community Edition setup completed at $(date)"
          echo "Web Interface: https://${OpenVPNElasticIP}/"
          echo "Client config: https://${OpenVPNElasticIP}/clients/client1/client1.ovpn"
          echo "Setup complete!"
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}

  # Test Instance 1 in Private Subnet 1
  PrivateTestInstance1:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id}}'
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref OpenVPNInstanceProfile
      SubnetId: !Ref PrivateSubnet1
      SecurityGroupIds:
        - !Ref PrivateInstanceSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail
          
          # Update system
          apt update -y
          DEBIAN_FRONTEND=noninteractive apt upgrade -y
          
          # Install nginx for testing HTTP connectivity
          DEBIAN_FRONTEND=noninteractive apt install -y nginx
          
          # Create a simple test page
          cat > /var/www/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Private Test Instance 1</title>
          </head>
          <body>
              <h1>Private Test Instance 1</h1>
              <p>This is a test instance in Private Subnet 1</p>
              <p>IP Address: $(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)</p>
              <p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>
              <p>If you can see this page, your VPN connection is working!</p>
          </body>
          </html>
          EOF
          
          # Start and enable nginx
          systemctl enable nginx
          systemctl start nginx
          
          # Create test file for download
          echo "VPN connectivity test successful from Private Instance 1" > /var/www/html/test.txt
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PrivateTest1

  # Test Instance 2 in Private Subnet 2
  PrivateTestInstance2:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id}}'
      InstanceType: t3.micro
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref OpenVPNInstanceProfile
      SubnetId: !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref PrivateInstanceSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail
          
          # Update system
          apt update -y
          DEBIAN_FRONTEND=noninteractive apt upgrade -y
          
          # Install nginx for testing HTTP connectivity
          DEBIAN_FRONTEND=noninteractive apt install -y nginx
          
          # Create a simple test page
          cat > /var/www/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Private Test Instance 2</title>
          </head>
          <body>
              <h1>Private Test Instance 2</h1>
              <p>This is a test instance in Private Subnet 2</p>
              <p>IP Address: $(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)</p>
              <p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>
              <p>If you can see this page, your VPN connection is working!</p>
          </body>
          </html>
          EOF
          
          # Start and enable nginx
          systemctl enable nginx
          systemctl start nginx
          
          # Create test file for download
          echo "VPN connectivity test successful from Private Instance 2" > /var/www/html/test.txt
      Tags:
        - Key: Name
          Value: !Sub ${ServerName}-PrivateTest2

  # Associate Elastic IP with Instance
  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref OpenVPNServer
      EIP: !Ref OpenVPNElasticIP

Outputs:
  ServerPublicIP:
    Description: Public IP address of the OpenVPN server
    Value: !Ref OpenVPNElasticIP
    Export:
      Name: !Sub ${AWS::StackName}-ServerIP

  WebInterface:
    Description: OpenVPN Community Web Interface URL
    Value: !Sub http://${OpenVPNElasticIP}/

  ClientConfigDownload:
    Description: Download URL for client configuration
    Value: !Sub http://${OpenVPNElasticIP}/clients/client1/client1.ovpn

  SSHCommand:
    Description: SSH command to connect to the server
    Value: !Sub ssh -i ~/.ssh/${KeyPairName}.pem ubuntu@${OpenVPNElasticIP}

  ClientManagement:
    Description: How to create additional client certificates
    Value: "SSH to server and run: sudo /etc/openvpn/create-client.sh <client_name>"

  InstanceId:
    Description: EC2 Instance ID
    Value: !Ref OpenVPNServer
    Export:
      Name: !Sub ${AWS::StackName}-InstanceId

  SecurityGroupId:
    Description: Security Group ID
    Value: !Ref OpenVPNSecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}-SecurityGroup

  PrivateTestInstance1IP:
    Description: Private IP of Test Instance 1
    Value: !GetAtt PrivateTestInstance1.PrivateIp

  PrivateTestInstance2IP:
    Description: Private IP of Test Instance 2
    Value: !GetAtt PrivateTestInstance2.PrivateIp

  PrivateTestInstance1Id:
    Description: Instance ID of Test Instance 1
    Value: !Ref PrivateTestInstance1

  PrivateTestInstance2Id:
    Description: Instance ID of Test Instance 2
    Value: !Ref PrivateTestInstance2

  VPNTestInstructions:
    Description: Instructions for testing VPN connectivity
    Value: !Sub |
      After connecting to VPN, test connectivity:
      1. Ping: ping ${PrivateTestInstance1.PrivateIp} or ping ${PrivateTestInstance2.PrivateIp}
      2. HTTP: curl http://${PrivateTestInstance1.PrivateIp} or curl http://${PrivateTestInstance2.PrivateIp}
      3. SSH: ssh -i ~/.ssh/${KeyPairName}.pem ubuntu@${PrivateTestInstance1.PrivateIp}
      4. Browser: http://${PrivateTestInstance1.PrivateIp} or http://${PrivateTestInstance2.PrivateIp}

  PrivateSubnets:
    Description: Private subnet information
    Value: !Sub "Private Subnet 1: 10.0.10.0/24, Private Subnet 2: 10.0.11.0/24"
