AWSTemplateFormatVersion: '2010-09-09'
Description: Auto Scaling Group with ALB, Launch Template, and Target Scaling Policy

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Default: course-site

  InstanceType:
    Type: String
    Default: t4g.micro
    AllowedValues:
      - t4g.micro
      - t4g.small
      - t4g.medium
      - t3.micro
      - t3.small
      - t3.medium
      - t2.micro
      - t2.small
      - t2.medium
    Description: EC2 instance type (ensure compatibility with selected architecture)

  MinSize:
    Type: Number
    Default: 1
    Description: Minimum number of instances in ASG

  MaxSize:
    Type: Number
    Default: 10
    Description: Maximum number of instances in ASG

  DesiredCapacity:
    Type: Number
    Default: 1
    Description: Desired number of instances in ASG

  # RDS Parameters
  DBName:
    Type: String
    Default: appdb
    Description: The name of the MySQL database to create
  # Credentials provided via Secrets Manager (see DBSecretArn)
  DBAllocatedStorage:
    Type: Number
    Default: 20
    Description: The size of the database (GiB)
  DBInstanceClass:
    Type: String
    Default: db.t4g.micro
    AllowedValues:
      - db.t4g.micro
      - db.t4g.small
      - db.t3.micro
      - db.t3.small
    Description: RDS instance class

  # Existing Secrets Manager ARN containing {"username":"...","password":"..."}
  DBSecretArn:
    Type: String
    Description: ARN of the Secrets Manager secret with keys 'username' and 'password' for the DB master credentials
    Default: arn:aws:secretsmanager:eu-west-1:050752632489:secret:course-site-db-2pWtuL

  # Toggle RDS public accessibility ("true" or "false")
  RDSPublicAccess:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: Whether the RDS instance should be publicly accessible and placed in public subnets

  # SSL Certificate ARNs for ALB HTTPS listener
  SSLCertificateArns:
    Type: CommaDelimitedList
    Description: List of SSL certificate ARNs from AWS Certificate Manager for HTTPS listener (comma-separated)
    Default: arn:aws:acm:eu-west-1:050752632489:certificate/f5e7f6bb-16b7-463b-b1e7-cd1254536c47

  # VPN Configuration Parameters
  VPNType:
    Type: String
    Default: "none"
    AllowedValues:
      - "none"
      - "openvpn-windows"
      - "openvpn-linux"
      - "aws-client-vpn"
    Description: Choose VPN type - None, OpenVPN Access Server (Windows), OpenVPN Community (Linux), or AWS Client VPN

  OpenVPNInstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.medium
      - t3.large
      - t3.xlarge
      - m5.large
      - m5.xlarge
    Description: EC2 instance type for Windows OpenVPN Server (minimum t3.medium recommended for Windows)

  OpenVPNAdminPassword:
    Type: String
    Default: OpenVPN123!
    Description: Password for OpenVPN admin user
    NoEcho: true
    MinLength: 8

  OpenVPNImageId:
    Type: String
    Description: AMI ID for OpenVPN Access Server (leave empty for auto-discovery)
    Default: ""
    ConstraintDescription: Must be a valid OpenVPN Access Server AMI ID for your region

  ASGImageId:
    Type: String
    Description: AMI ID for ASG instances (leave empty to use latest Amazon Linux 2023 ARM64)
    Default: ""

  ASGArchitecture:
    Type: String
    Default: arm64
    AllowedValues:
      - arm64
      - x86_64
    Description: CPU architecture for ASG instances (affects AMI selection)

  ClientVPNCidr:
    Type: String
    Default: 10.50.0.0/16
    Description: CIDR block for Client VPN clients (must not overlap with VPC CIDR)
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$'

  ServerCertificateArn:
    Type: String
    Description: ARN of the server certificate for Client VPN authentication (must be imported to ACM)
    Default: ""

  ClientCertificateArn:
    Type: String
    Description: ARN of the client certificate for Client VPN authentication (must be imported to ACM)
    Default: ""

  ClientVPNLogGroupName:
    Type: String
    Default: "/aws/clientvpn"
    Description: CloudWatch log group name for Client VPN connection logs

Mappings:
  # Linux OpenVPN Access Server AMI IDs by Region (Commercial with Web UI)
  LinuxOpenVPNAMIMap:
    us-east-1:
      AMI: ami-008650bc87cdf5e34
    us-west-2:
      AMI: ami-014e9d653a4445da4
    eu-west-1:
      AMI: ami-036178441a3eabb6a
    eu-central-1:
      AMI: ami-039470c0765f439c4
    # Add more regions as needed

Conditions:
  PublicRDS: !Equals [ !Ref RDSPublicAccess, "true" ]
  HasMultipleCertificates: !Not [!Equals [!Join ['', !Ref SSLCertificateArns], !Select [0, !Ref SSLCertificateArns]]]
  DeployOpenVPNWindows: !Equals [ !Ref VPNType, "openvpn-windows" ]
  DeployOpenVPNLinux: !Equals [ !Ref VPNType, "openvpn-linux" ]
  DeployClientVPN: !Equals [ !Ref VPNType, "aws-client-vpn" ]
  DeployAnyOpenVPN: !Or [ !Condition DeployOpenVPNWindows, !Condition DeployOpenVPNLinux ]
  UseCustomASGAMI: !Not [!Equals [!Ref ASGImageId, ""]]
  UseCustomOpenVPNAMI: !Not [!Equals [!Ref OpenVPNImageId, ""]]
  HasServerCert: !Not [!Equals [!Ref ServerCertificateArn, ""]]
  HasClientCert: !Not [!Equals [!Ref ClientCertificateArn, ""]]

Resources:
  # VPC
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: ASG-VPC

  # Internet Gateway
  MyInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: ASG-InternetGateway

  # Attach Internet Gateway to VPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref MyVPC
      InternetGatewayId: !Ref MyInternetGateway

  # Public Subnets (for ALB)
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: PublicSubnet1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: PublicSubnet2

  # Private Subnets (for EC2 instances)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: PrivateSubnet1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: PrivateSubnet2

  # NAT Gateway Elastic IP
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  # NAT Gateway
  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: ASG-NATGateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MyVPC
      Tags:
        - Key: Name
          Value: PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MyVPC
      Tags:
        - Key: Name
          Value: PrivateRouteTable

  # Routes
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref MyInternetGateway

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # Subnet Route Table Associations
  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # IAM Role for EC2 instances
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: EC2-CloudWatch-Role

  # Instance Profile
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # Allow EC2 instances to read the DB secret from Secrets Manager
  EC2ReadDBSecretPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: ReadDBSecret
      Roles:
        - !Ref EC2Role
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
              - secretsmanager:DescribeSecret
            Resource:
              - !Ref DBSecretArn

  # Security Groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: ALBSecurityGroup

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2 instances
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5001
          ToPort: 5001
          SourceSecurityGroupId: !Ref ALBSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: EC2SecurityGroup

  # RDS Security Group (allow MySQL from EC2 instances only)
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS MySQL allowing access from EC2 instances
      VpcId: !Ref MyVPC
      SecurityGroupIngress: !If 
        - PublicRDS
        - 
          - IpProtocol: tcp
            FromPort: 3306
            ToPort: 3306
            CidrIp: 0.0.0.0/0
        - 
          - IpProtocol: tcp
            FromPort: 3306
            ToPort: 3306
            SourceSecurityGroupId: !Ref EC2SecurityGroup
      Tags:
        - Key: Name
          Value: RDSSecurityGroup

  # OpenVPN Security Group
  OpenVPNSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: DeployAnyOpenVPN
    Properties:
      GroupDescription: Security group for OpenVPN Access Server
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: udp
          FromPort: 1194
          ToPort: 1194
          CidrIp: 0.0.0.0/0
          Description: OpenVPN UDP traffic
        - IpProtocol: tcp
          FromPort: 1194
          ToPort: 1194
          CidrIp: 0.0.0.0/0
          Description: OpenVPN TCP traffic
        - !If
          - DeployOpenVPNLinux
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: 0.0.0.0/0
            Description: SSH access for Linux
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: 0.0.0.0/0
            Description: RDP access for Windows
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS Web Admin Interface
        - IpProtocol: tcp
          FromPort: 943
          ToPort: 943
          CidrIp: 0.0.0.0/0
          Description: OpenVPN Access Server Web Interface
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: All outbound traffic
      Tags:
        - Key: Name
          Value: OpenVPN-SecurityGroup

  # DB Subnet Group (use private subnets)
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS in private subnets
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: DBSubnetGroup

  # Public DB Subnet Group (use public subnets for public accessibility)
  DBPublicSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for publicly accessible RDS in public subnets
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: DBPublicSubnetGroup

  # OpenVPN IAM Role
  OpenVPNRole:
    Type: AWS::IAM::Role
    Condition: DeployAnyOpenVPN
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: OpenVPN-Role

  # OpenVPN Instance Profile
  OpenVPNInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: DeployAnyOpenVPN
    Properties:
      Roles:
        - !Ref OpenVPNRole

  # OpenVPN Elastic IP
  OpenVPNElasticIP:
    Type: AWS::EC2::EIP
    Condition: DeployAnyOpenVPN
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: OpenVPN-EIP

  # OpenVPN Access Server Instance
  OpenVPNAccessServer:
    Type: AWS::EC2::Instance
    Condition: DeployAnyOpenVPN
    Properties:
      ImageId: !If
        - UseCustomOpenVPNAMI
        - !Ref OpenVPNImageId
        - !If
          - DeployOpenVPNLinux
          - !FindInMap [LinuxOpenVPNAMIMap, !Ref "AWS::Region", AMI]
          - !Sub '{{resolve:ssm:/aws/service/ami-windows-latest/Windows_Server-2022-English-Full-Base}}'
      InstanceType: !Ref OpenVPNInstanceType
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref OpenVPNInstanceProfile
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !Ref OpenVPNSecurityGroup
      SourceDestCheck: false
      UserData: !If
        - DeployOpenVPNLinux
        - Fn::Base64: !Sub |
            #!/bin/bash
            # OpenVPN Access Server setup
            /usr/local/openvpn_as/bin/ovpn-init --batch --force
            /usr/local/openvpn_as/scripts/sacli --user openvpn --new_pass "${OpenVPNAdminPassword}" SetLocalPassword
            /usr/local/openvpn_as/scripts/sacli start
        - Fn::Base64: !Sub |
            <powershell>
            # Windows OpenVPN Community setup
            Write-Host "Setting up OpenVPN Community Edition on Windows..."
            # Add Windows-specific OpenVPN setup here
            </powershell>
  OpenVPNEIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Condition: DeployAnyOpenVPN
    Properties:
      InstanceId: !Ref OpenVPNAccessServer
      EIP: !Ref OpenVPNElasticIP

  # Client VPN Resources
  ClientVPNLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: DeployClientVPN
    Properties:
      LogGroupName: !Ref ClientVPNLogGroupName
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-ClientVPN-LogGroup

  ClientVPNLogStream:
    Type: AWS::Logs::LogStream
    Condition: DeployClientVPN
    Properties:
      LogGroupName: !Ref ClientVPNLogGroupName
      LogStreamName: ClientVPNConnectionLogs
    DependsOn: ClientVPNLogGroup

  ClientVPNEndpoint:
    Type: AWS::EC2::ClientVpnEndpoint
    Condition: DeployClientVPN
    Properties:
      Description: !Sub ${AWS::StackName} Client VPN Endpoint
      ClientCidrBlock: !Ref ClientVPNCidr
      ServerCertificateArn: !Ref ServerCertificateArn
      AuthenticationOptions:
        - Type: certificate-authentication
          MutualAuthentication:
            ClientRootCertificateChainArn: !Ref ClientCertificateArn
      ConnectionLogOptions:
        Enabled: true
        CloudwatchLogGroup: !Ref ClientVPNLogGroup
        CloudwatchLogStream: !Ref ClientVPNLogStream
      DnsServers:
        - 8.8.8.8
        - 8.8.4.4
      SplitTunnel: true
      VpnPort: 443
      TransportProtocol: udp

  ClientVPNTargetNetworkAssociation1:
    Type: AWS::EC2::ClientVpnTargetNetworkAssociation
    Condition: DeployClientVPN
    Properties:
      ClientVpnEndpointId: !Ref ClientVPNEndpoint
      SubnetId: !Ref PrivateSubnet1

  ClientVPNTargetNetworkAssociation2:
    Type: AWS::EC2::ClientVpnTargetNetworkAssociation
    Condition: DeployClientVPN
    Properties:
      ClientVpnEndpointId: !Ref ClientVPNEndpoint
      SubnetId: !Ref PrivateSubnet2

  ClientVPNAuthorizationRule:
    Type: AWS::EC2::ClientVpnAuthorizationRule
    Condition: DeployClientVPN
    Properties:
      ClientVpnEndpointId: !Ref ClientVPNEndpoint
      TargetNetworkCidr: 10.0.0.0/16
      AuthorizeAllGroups: true
      Description: Allow access to VPC

  # Note: AWS Client VPN automatically creates routes to VPC CIDR when target networks are associated
  # Manual routes are not needed and cause "Route already exists" errors

  # RDS MySQL Instance
  MyRDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceClass
      Engine: mysql
      EngineVersion: '8.0'
      MasterUsername: !Sub '{{resolve:secretsmanager:${DBSecretArn}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBSecretArn}:SecretString:password}}'
      DBName: !Ref DBName
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !If [ PublicRDS, !Ref DBPublicSubnetGroup, !Ref DBSubnetGroup ]
      PubliclyAccessible: !If [ PublicRDS, true, false ]
      MultiAZ: false
      StorageType: gp3
      AutoMinorVersionUpgrade: true
      BackupRetentionPeriod: 7
      DeletionProtection: false

  # Launch Template
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: WebServerLaunchTemplate
      LaunchTemplateData:
        ImageId: !If
          - UseCustomASGAMI
          - !Ref ASGImageId
          - !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-${ASGArchitecture}}}'
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -euxo pipefail
            dnf update -y
            dnf install -y nodejs
            node --version > /var/log/node-version.log 2>&1 || true


            sudo yum install git -y
            # Ensure app directory exists under ec2-user home
            APP_DIR="/home/ec2-user/3tierapp-course-site/course-site-with-nodejs-backend-db/server-nodejs"
            if [ ! -d "/home/ec2-user/3tierapp-course-site" ]; then
              su - ec2-user -c "git clone https://github.com/ronhadad22/3tierapp-course-site.git /home/ec2-user/3tierapp-course-site"
            fi
            chown -R ec2-user:ec2-user /home/ec2-user/3tierapp-course-site

            # Create systemd service to keep the app running and restart on failure
            cat >/etc/systemd/system/course-site.service << 'SERVICE'
            [Unit]
            Description=Course Site Node.js Server
            After=network-online.target
            Wants=network-online.target

            [Service]
            Type=simple
            User=ec2-user
            WorkingDirectory=/home/ec2-user/3tierapp-course-site/course-site-with-nodejs-backend-db/server-nodejs
            Environment=AWS_REGION=${AWS::Region}
            Environment=DB_USERPASS_SECRET_ARN=${DBSecretArn}
            Environment=DB_HOST=${MyRDSInstance.Endpoint.Address}
            Environment=DB_NAME=coursedb
            Environment=DB_PORT=3306
            Environment=DB_PARAMS=sslmode=REQUIRED
            ExecStartPre=/usr/bin/bash -lc 'if [ -d /home/ec2-user/3tierapp-course-site/.git ]; then git -C /home/ec2-user/3tierapp-course-site pull --rebase; else git clone https://github.com/ronhadad22/3tierapp-course-site.git /home/ec2-user/3tierapp-course-site; fi'
            ExecStartPre=/usr/bin/npm install
            ExecStartPre=/usr/bin/npm run prisma:migrate:dev
            ExecStartPre=/usr/bin/npm run prisma:generate
            ExecStart=/usr/bin/npm start
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
            SERVICE

            systemctl daemon-reload
            systemctl enable --now course-site.service
            
            # Install and start Docker
            #dnf install -y docker
            #systemctl enable docker
            #systemctl start docker
            #usermod -aG docker ec2-user || true

            # Pull application image from GHCR (public)
            #docker pull ghcr.io/ronhadad22/course-site-backend/server-nodejs:v1.1.9
            
            # Run container on port 80
            #docker rm -f server-nodejs || true
            #docker run -d --restart unless-stopped \
              --name server-nodejs \
              -p 80:80 \
              ghcr.io/ronhadad22/course-site-backend/server-nodejs:v1.1.9
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: ASG-WebServer

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: ASG-ALB
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: ASG-ALB

  # Target Group
  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 5001
      Protocol: HTTP
      VpcId: !Ref MyVPC
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      TargetType: instance
      Matcher:
        HttpCode: '200'
      Tags:
        - Key: Name
          Value: ASG-TargetGroup

  # ALB Listener
  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Select [0, !Ref SSLCertificateArns]
      SslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06

  # Additional SSL Certificates (if more than one provided)
  AdditionalSSLCertificates:
    Type: AWS::ElasticLoadBalancingV2::ListenerCertificate
    Condition: HasMultipleCertificates
    Properties:
      ListenerArn: !Ref ALBListener
      Certificates:
        - CertificateArn: !Select [1, !Ref SSLCertificateArns]

  # Auto Scaling Group
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: WebServer-ASG
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      TargetGroupARNs:
        - !Ref TargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: ASG-WebServer
          PropagateAtLaunch: true

  # Target Tracking Scaling Policy - ALB Request Count Per Target
  TargetTrackingScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ALBRequestCountPerTarget
          ResourceLabel: !Sub 
            - "${LoadBalancerFullName}/${TargetGroupFullName}"
            - LoadBalancerFullName: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
              TargetGroupFullName: !GetAtt TargetGroup.TargetGroupFullName
        TargetValue: 100.0

  # Additional Scaling Policy - CPU Utilization (backup)
  CPUTargetTrackingScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref MyVPC
    Export:
      Name: !Sub ${AWS::StackName}-VPC-ID

  ApplicationLoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub ${AWS::StackName}-ALB-DNS

  ApplicationLoadBalancerURL:
    Description: URL of the Application Load Balancer
    Value: !Sub https://${ApplicationLoadBalancer.DNSName}

  AutoScalingGroupName:
    Description: Name of the Auto Scaling Group
    Value: !Ref AutoScalingGroup

  TargetGroupArn:
    Description: ARN of Target Group
    Value: !Ref TargetGroup

  LaunchTemplateId:
    Description: ID of the Launch Template
    Value: !Ref LaunchTemplate

  RDSEndpointAddress:
    Description: RDS MySQL endpoint address
    Value: !GetAtt MyRDSInstance.Endpoint.Address

  RDSSecurityGroupId:
    Description: Security Group ID for RDS
    Value: !Ref RDSSecurityGroup

  DBSecretArnOut:
    Description: ARN of the Secrets Manager secret used for DB credentials
    Value: !Ref DBSecretArn

  TargetTrackingPolicyArn:
    Description: ARN of the Target Tracking Scaling Policy
    Value: !Ref TargetTrackingScalingPolicy

  # OpenVPN Outputs
  OpenVPNServerPublicIP:
    Condition: DeployAnyOpenVPN
    Description: Public IP address of the OpenVPN Server
    Value: !Ref OpenVPNElasticIP
    Export:
      Name: !Sub ${AWS::StackName}-OpenVPN-ServerIP

  OpenVPNAdminWebInterface:
    Condition: DeployOpenVPNLinux
    Description: OpenVPN Access Server Admin Web Interface URL (Linux only)
    Value: !Sub https://${OpenVPNElasticIP}:943/admin

  OpenVPNClientWebInterface:
    Condition: DeployOpenVPNLinux
    Description: OpenVPN Access Server Client Web Interface URL (Linux only)
    Value: !Sub https://${OpenVPNElasticIP}:943/

  OpenVPNAdminCredentials:
    Condition: DeployAnyOpenVPN
    Description: Admin login credentials
    Value: !Sub |
      Username: openvpn
      Password: ${OpenVPNAdminPassword}

  OpenVPNRDPCommand:
    Condition: DeployOpenVPNWindows
    Description: RDP command to connect to the Windows OpenVPN server
    Value: !Sub mstsc /v:${OpenVPNElasticIP}

  OpenVPNSetupInstructions:
    Condition: DeployAnyOpenVPN
    Description: Setup instructions for OpenVPN Server
    Value: !If
      - DeployOpenVPNLinux
      - !Sub |
          OpenVPN Access Server (Linux) is ready!
          
          ADMIN ACCESS:
          1. Admin Interface: https://${OpenVPNElasticIP}:943/admin
          2. Username: openvpn
          3. Password: ${OpenVPNAdminPassword}
          
          CLIENT ACCESS:
          1. Client Interface: https://${OpenVPNElasticIP}:943/
          2. Download client profiles from web interface
          3. Import .ovpn file into OpenVPN client
          4. Connect using your credentials
      - !Sub |
          OpenVPN Community (Windows) is ready!
          
          CLIENT CONNECTION:
          1. Connect via RDP: mstsc /v:${OpenVPNElasticIP}
          2. Download client files from: C:\OpenVPN\client-configs\
          3. Copy these files to your client device:
             - client1.ovpn (main config file)
             - ca.crt, client1.crt, client1.key, ta.key
          4. Import client1.ovpn into your OpenVPN client
          5. Connect using your OpenVPN client
          
          SERVER MANAGEMENT:
          - Service: OpenVPNServer (running automatically)
          - Logs: C:\OpenVPN\log\openvpn.log

  # Client VPN Outputs
  ClientVPNEndpointId:
    Condition: DeployClientVPN
    Description: Client VPN Endpoint ID
    Value: !Ref ClientVPNEndpoint
    Export:
      Name: !Sub ${AWS::StackName}-ClientVPN-EndpointId

  # Note: ClientVPN DNS name is not available as CloudFormation attribute
  # DNS name can be found in AWS Console after deployment

  ClientVPNClientCidr:
    Condition: DeployClientVPN
    Description: Client VPN Client CIDR Block
    Value: !Ref ClientVPNCidr

  ClientVPNSetupInstructions:
    Condition: DeployClientVPN
    Description: Instructions for setting up AWS Client VPN
    Value: !Sub |
      AWS Client VPN Endpoint Setup Complete!
      
      CERTIFICATE SETUP (Required before first use):
      1. Generate server and client certificates using OpenSSL or Easy-RSA
      2. Import certificates to AWS Certificate Manager (ACM)
      3. Update CloudFormation parameters with certificate ARNs
      4. Redeploy the stack
      
      CLIENT CONNECTION:
      1. Download AWS VPN Client from: https://aws.amazon.com/vpn/client-vpn-download/
      2. In AWS Console, go to VPC → Client VPN Endpoints
      3. Select endpoint: ${ClientVPNEndpoint}
      4. Click "Download Client Configuration"
      5. Import the .ovpn file into AWS VPN Client
      6. Connect using your client certificate
      
      ENDPOINT DETAILS:
      - Endpoint ID: ${ClientVPNEndpoint}
      - DNS Name: Check AWS Console → VPC → Client VPN Endpoints
      - Client CIDR: ${ClientVPNCidr}
      - VPC Access: 10.0.0.0/16
      
      TROUBLESHOOTING:
      - Check CloudWatch logs: ${ClientVPNLogGroupName}
      - Verify certificates are valid and imported to ACM
      - Ensure client certificate matches the one specified in parameters
