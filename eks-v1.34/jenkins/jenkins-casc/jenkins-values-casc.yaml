persistence:
  enabled: true
  storageClass: "jenkins-ebs-sc"
  accessMode: "ReadWriteOnce"
  size: "8Gi"

# Add toleration for system nodes
tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
    effect: "NoSchedule"

controller:
  # Install essential plugins
  installPlugins:
    - kubernetes:4246.v5a_12b_1fe120e
    - workflow-aggregator:596.v8c21c963d92d
    - git:5.2.2
    - configuration-as-code:1810.v9b_c30a_249a_4c
    - docker-workflow:580.vc0c340686b_54
    - amazon-ecr:1.7.3
    - job-dsl:1.87
    - pipeline-stage-view:2.34
    - blueocean:1.27.14
    - github:1.40.0
    - workflow-multibranch:795.ve0cb_1f45ca_9a_
    - credentials:1371.vfee6b_095f0a_3
    - plain-credentials:183.va_de8f1dd5a_2b_
    - ssh-credentials:337.v395d2403ccd4
    - timestamper:1.27
    - ws-cleanup:0.46
    - build-timeout:1.33
    - ant:475.vf34069fef73c
    - gradle:2.13
    - workflow-cps:3900.va_17f2131d2dc
    - pipeline-milestone-step:119.vdfdc43fc3b_9a_
    - pipeline-input-step:495.ve9c153f6067b_
    - pipeline-stage-step:312.v8cd10304c27a_
    - matrix-project:822.824.v14451b_c0fd42
    - resource-disposer:0.23
    - ssh-slaves:2.973.v0fa_8c0dea_f9f
    - ldap:727.v7b_18d711a_64e
    - email-ext:701.vf9ecc394d18e
    - mailer:472.vf7c289a_4b_420
    
  # JCasC configuration
  JCasC:
    defaultConfig: true
    configScripts:
      jenkins-config: |
        jenkins:
          systemMessage: "Jenkins configured automatically by JCasC with ECR access"
          
          authorizationStrategy:
            loggedInUsersCanDoAnything:
              allowAnonymousRead: false
              
          securityRealm:
            local:
              allowsSignup: false
              enableCaptcha: false
              users:
              - id: "admin"
                name: "Jenkins Admin"
                password: "${JENKINS_ADMIN_PASSWORD:-admin123}"

          clouds:
          - kubernetes:
              containerCap: 10
              containerCapStr: "10"
              jenkinsTunnel: "jenkins-agent.jenkins.svc.cluster.local:50000"
              jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
              name: "kubernetes"
              namespace: "jenkins"
              serverUrl: "https://kubernetes.default"
              templates:
              # Docker + ECR agent with IRSA
              - containers:
                - name: "jnlp"
                  image: "jenkins/inbound-agent:3345.v03dee9b_f88fc-6"
                  args: "^${computer.jnlpmac} ^${computer.name}"
                  resourceRequestCpu: "100m"
                  resourceRequestMemory: "256Mi"
                  resourceLimitCpu: "500m"
                  resourceLimitMemory: "512Mi"
                - name: "docker"
                  image: "docker:24-dind"
                  privileged: true
                  envVars:
                  - envVar:
                      key: "DOCKER_TLS_CERTDIR"
                      value: ""
                  volumeMounts:
                  - mountPath: "/var/run/docker.sock"
                    name: "docker-sock"
                  resourceRequestCpu: "500m"
                  resourceRequestMemory: "512Mi"
                  resourceLimitCpu: "1"
                  resourceLimitMemory: "2Gi"
                - name: "aws-cli"
                  image: "amazon/aws-cli:latest"
                  command: "cat"
                  ttyEnabled: true
                  envVars:
                  - envVar:
                      key: "AWS_DEFAULT_REGION"
                      value: "us-east-1"
                  resourceRequestCpu: "100m"
                  resourceRequestMemory: "256Mi"
                  resourceLimitCpu: "500m"
                  resourceLimitMemory: "512Mi"
                volumes:
                - hostPathVolume:
                    hostPath: "/var/run/docker.sock"
                    mountPath: "/var/run/docker.sock"
                label: "docker ecr"
                name: "docker-ecr-agent"
                namespace: "jenkins"
                nodeUsageMode: "EXCLUSIVE"
                podRetention: "never"
                serviceAccount: "jenkins-agent"
                slaveConnectTimeout: 100
                yaml: |
                  apiVersion: v1
                  kind: Pod
                  spec:
                    serviceAccountName: jenkins-agent

          crumbIssuer:
            standard:
              excludeClientIPFromCrumb: true
              
          disableRememberMe: false
          mode: NORMAL
          numExecutors: 0
          quietPeriod: 5
          scmCheckoutRetryCount: 0
          slaveAgentPort: 50000
          
          remotingSecurity:
            enabled: true
            
          markupFormatter: "plainText"

        jobs:
          - script: |
              pipelineJob('ecr-build-sample') {
                description('Sample pipeline to build and push to ECR')
                definition {
                  cps {
                    script('''
                      pipeline {
                        agent { label 'docker ecr' }
                        environment {
                          ECR_REGISTRY = "950555670656.dkr.ecr.us-east-1.amazonaws.com"
                          IMAGE_REPO = "sample-app"
                          IMAGE_TAG = "${BUILD_NUMBER}"
                          AWS_DEFAULT_REGION = "us-east-1"
                        }
                        stages {
                          stage('Build') {
                            steps {
                              container('docker') {
                                sh '''
                                  echo "FROM alpine:latest" > Dockerfile
                                  echo "RUN echo 'Hello from Jenkins Build #${BUILD_NUMBER}'" >> Dockerfile
                                  docker build -t ${IMAGE_REPO}:${IMAGE_TAG} .
                                '''
                              }
                            }
                          }
                          stage('Push to ECR') {
                            steps {
                              container('aws-cli') {
                                sh 'aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}'
                              }
                              container('docker') {
                                sh '''
                                  docker tag ${IMAGE_REPO}:${IMAGE_TAG} ${ECR_REGISTRY}/${IMAGE_REPO}:${IMAGE_TAG}
                                  docker tag ${IMAGE_REPO}:${IMAGE_TAG} ${ECR_REGISTRY}/${IMAGE_REPO}:latest
                                  docker push ${ECR_REGISTRY}/${IMAGE_REPO}:${IMAGE_TAG}
                                  docker push ${ECR_REGISTRY}/${IMAGE_REPO}:latest
                                '''
                              }
                            }
                          }
                        }
                        post {
                          always {
                            echo "Build completed. Image pushed to ECR."
                          }
                        }
                      }
                    ''')
                    sandbox()
                  }
                }
              }

        security:
          apiToken:
            creationOfLegacyTokenEnabled: false
            tokenGenerationOnCreationEnabled: false
            usageStatisticsEnabled: true
          gitHostKeyVerificationConfiguration:
            sshHostKeyVerificationStrategy: "knownHostsFileVerificationStrategy"
          scriptApproval:
            forceSandbox: false

        unclassified:
          location:
            adminAddress: "admin@company.com"
            url: "http://jenkins.jenkins.svc.cluster.local:8080/"
          scmGit:
            addGitTagAction: false
            allowSecondFetch: false
            createAccountBasedOnEmail: false
            disableGitToolChooser: false
            hideCredentials: false
            showEntireCommitSummaryInChanges: false
            useExistingAccountWithSameEmail: false

        tool:
          git:
            installations:
            - home: "git"
              name: "Default"

  # Admin user configuration
  admin:
    existingSecret: ""
    userKey: jenkins-admin-user
    passwordKey: jenkins-admin-password
    
  # Security settings
  csrf:
    defaultCrumbIssuer:
      enabled: true
      proxyCompatability: true

# Agent configuration
agent:
  enabled: true
  defaultsProviderTemplate: ""
