AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Generic Amazon EKS v1.34 cluster for AWS training environments. Students can deploy
  this stack in any account and region with minimal changes.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Cluster configuration
        Parameters:
          - ClusterName
          - KubernetesVersion
          - OidcThumbprint
          - AuthenticationMode
      - Label:
          default: Node group settings
        Parameters:
          - NodeGroupName
          - NodeInstanceType
          - NodeAmiType
          - NodeGroupDesiredSize
          - NodeGroupMinSize
          - NodeGroupMaxSize
          - KeyPairName
      - Label:
          default: Networking (adjust per region if needed)
        Parameters:
          - VpcCidr
          - PublicSubnet1Cidr
          - PublicSubnet2Cidr
          - PrivateSubnet1Cidr
          - PrivateSubnet2Cidr
    ParameterLabels:
      ClusterName:
        default: EKS cluster name
      KubernetesVersion:
        default: Kubernetes version
      AuthenticationMode:
        default: Authentication mode
      NodeGroupName:
        default: Node group name
      NodeInstanceType:
        default: Worker node instance type
      NodeGroupDesiredSize:
        default: Desired node count
      NodeGroupMinSize:
        default: Minimum node count
      NodeGroupMaxSize:
        default: Maximum node count
      KeyPairName:
        default: SSH key pair (optional)
      VpcCidr:
        default: VPC CIDR
      PublicSubnet1Cidr:
        default: Public subnet A CIDR
      PublicSubnet2Cidr:
        default: Public subnet B CIDR
      PrivateSubnet1Cidr:
        default: Private subnet A CIDR
      PrivateSubnet2Cidr:
        default: Private subnet B CIDR

Parameters:
  ClusterName:
    Type: String
    Default: student-eks-cluster
    MinLength: 1
    MaxLength: 100
    Description: Name of the Amazon EKS cluster

  KubernetesVersion:
    Type: String
    Default: '1.34'
    AllowedValues:
      - '1.34'
      - '1.33'
      - '1.32'
    Description: Kubernetes control plane version

  AuthenticationMode:
    Type: String
    Default: API_AND_CONFIG_MAP
    AllowedValues:
      - API_AND_CONFIG_MAP
      - API
      - CONFIG_MAP
    Description: >-
      Authentication mode for the cluster access configuration. API_AND_CONFIG_MAP
      supports both the legacy aws-auth ConfigMap and the new access API.

  NodeGroupName:
    Type: String
    Default: student-nodes
    MinLength: 1
    MaxLength: 63
    Description: Name of the managed node group

  NodeInstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - m5.large
      - m5.xlarge
      - c5.large
      - c5.xlarge
    Description: EC2 instance type for worker nodes (x86_64)

  NodeAmiType:
    Type: String
    Default: AL2023_x86_64_STANDARD
    AllowedValues:
      - AL2023_x86_64_STANDARD
      - AL2023_ARM_64_STANDARD
      - AL2_x86_64
      - AL2_ARM_64
      - BOTTLEROCKET_x86_64
      - BOTTLEROCKET_ARM_64
    Description: >-
      Operating system for managed node group. Use an AL2023 option for Kubernetes
      1.33 or later. Ensure instance types match the architecture.

  NodeGroupDesiredSize:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 10
    Description: Desired number of worker nodes

  NodeGroupMinSize:
    Type: Number
    Default: 1
    MinValue: 1
    MaxValue: 10
    Description: Minimum number of worker nodes

  NodeGroupMaxSize:
    Type: Number
    Default: 4
    MinValue: 1
    MaxValue: 10
    Description: Maximum number of worker nodes

  KeyPairName:
    Type: String
    Default: ''
    Description: >-
      (Optional) Existing EC2 key pair for SSH access to worker nodes. Leave blank
      to disable SSH access.

  OidcThumbprint:
    Type: String
    Default: 9e99a48a9960b14926bb7f3b3b4d0872168d4e7d
    AllowedPattern: '^[0-9A-Fa-f]{40}$'
    Description: >-
      SHA-1 fingerprint of the root certificate for the EKS OIDC issuer. Use AWS
      documentation to confirm the value for your region.

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block must be in the form x.x.x.x/16-28
    Description: CIDR block for the new VPC

  PublicSubnet1Cidr:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR block for the first public subnet

  PublicSubnet2Cidr:
    Type: String
    Default: 10.0.2.0/24
    Description: CIDR block for the second public subnet

  PrivateSubnet1Cidr:
    Type: String
    Default: 10.0.10.0/24
    Description: CIDR block for the first private subnet

  PrivateSubnet2Cidr:
    Type: String
    Default: 10.0.20.0/24
    Description: CIDR block for the second private subnet

Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-vpc'
        - Key: Environment
          Value: Training

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-igw'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1Cidr
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-public-subnet-a'
        - Key: !Sub 'kubernetes.io/cluster/${ClusterName}'
          Value: shared
        - Key: kubernetes.io/role/elb
          Value: '1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2Cidr
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-public-subnet-b'
        - Key: !Sub 'kubernetes.io/cluster/${ClusterName}'
          Value: shared
        - Key: kubernetes.io/role/elb
          Value: '1'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1Cidr
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-private-subnet-a'
        - Key: !Sub 'kubernetes.io/cluster/${ClusterName}'
          Value: owned
        - Key: kubernetes.io/role/internal-elb
          Value: '1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet2Cidr
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-private-subnet-b'
        - Key: !Sub 'kubernetes.io/cluster/${ClusterName}'
          Value: owned
        - Key: kubernetes.io/role/internal-elb
          Value: '1'

  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-nat-eip'

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-nat'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-public-rt'

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-private-rt-a'

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-private-rt-b'

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  ControlPlaneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Amazon EKS control plane to communicate with worker nodes
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-control-plane-sg'

  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - eks.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-cluster-role'

  EKSNodeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-node-role'

  EKSCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Name: !Ref ClusterName
      Version: !Ref KubernetesVersion
      RoleArn: !GetAtt EKSClusterRole.Arn
      AccessConfig:
        AuthenticationMode: !Ref AuthenticationMode
        BootstrapClusterCreatorAdminPermissions: true
      ResourcesVpcConfig:
        SecurityGroupIds:
          - !Ref ControlPlaneSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        EndpointPublicAccess: true
        EndpointPrivateAccess: true
        PublicAccessCidrs:
          - 0.0.0.0/0
      Logging:
        ClusterLogging:
          EnabledTypes:
            - Type: api
            - Type: audit
            - Type: authenticator
            - Type: controllerManager
            - Type: scheduler
      Tags:
        - Key: Name
          Value: !Ref ClusterName
        - Key: Environment
          Value: Training

  EKSClusterOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    DependsOn: EKSCluster
    Properties:
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - !Ref OidcThumbprint
      Url: !GetAtt EKSCluster.OpenIdConnectIssuerUrl

  EbsCsiControllerRole:
    Type: AWS::IAM::Role
    DependsOn:
      - EKSClusterOIDCProvider
    Properties:
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "${EKSClusterOIDCProvider}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${IssuerHost}:aud": "sts.amazonaws.com",
                      "${IssuerHost}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                    }
                  }
                }
              ]
            }
          - {
              EKSClusterOIDCProvider: !Ref EKSClusterOIDCProvider,
              IssuerHost: !Select [1, !Split ['https://', !GetAtt EKSCluster.OpenIdConnectIssuerUrl]]
            }
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-ebs-csi-role'

  EKSNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSCluster
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Ref NodeGroupName
      NodeRole: !GetAtt EKSNodeRole.Arn
      AmiType: !Ref NodeAmiType
      CapacityType: ON_DEMAND
      InstanceTypes:
        - !Ref NodeInstanceType
      DiskSize: 20
      Subnets:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      ScalingConfig:
        DesiredSize: !Ref NodeGroupDesiredSize
        MinSize: !Ref NodeGroupMinSize
        MaxSize: !Ref NodeGroupMaxSize
      UpdateConfig:
        MaxUnavailable: 1
      RemoteAccess: !If
        - HasKeyPair
        - {Ec2SshKey: !Ref KeyPairName}
        - !Ref AWS::NoValue
      Tags:
        Environment: Training
        Name: !Ref NodeGroupName

  EKSAddonVPCCNI:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: vpc-cni
      ResolveConflicts: OVERWRITE

  EKSAddonCoreDNS:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: coredns
      ResolveConflicts: OVERWRITE

  EKSAddonKubeProxy:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: kube-proxy
      ResolveConflicts: OVERWRITE

  EKSAddonEBSCSI:
    Type: AWS::EKS::Addon
    DependsOn:
      - EKSNodeGroup
      - EbsCsiControllerRole
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: aws-ebs-csi-driver
      ServiceAccountRoleArn: !GetAtt EbsCsiControllerRole.Arn
      ResolveConflicts: OVERWRITE

Outputs:
  ClusterName:
    Description: Name of the Amazon EKS cluster
    Value: !Ref ClusterName
    Export:
      Name: !Sub '${AWS::StackName}-ClusterName'

  ClusterEndpoint:
    Description: EKS cluster endpoint URL
    Value: !GetAtt EKSCluster.Endpoint
    Export:
      Name: !Sub '${AWS::StackName}-ClusterEndpoint'

  ClusterArn:
    Description: Amazon Resource Name (ARN) of the EKS cluster
    Value: !GetAtt EKSCluster.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ClusterArn'

  ClusterSecurityGroupId:
    Description: Security group ID of the EKS control plane
    Value: !GetAtt EKSCluster.ClusterSecurityGroupId
    Export:
      Name: !Sub '${AWS::StackName}-ClusterSecurityGroupId'

  NodeInstanceRoleArn:
    Description: IAM role ARN attached to worker nodes
    Value: !GetAtt EKSNodeRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-NodeInstanceRoleArn'

  VpcId:
    Description: Identifier of the created VPC
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'

  PrivateSubnetIds:
    Description: Comma-separated list of private subnet IDs
    Value: !Join [",", [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnetIds'

  PublicSubnetIds:
    Description: Comma-separated list of public subnet IDs
    Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2]]
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnetIds'

  KubeconfigCommand:
    Description: CLI command to update kubeconfig for this cluster
    Value: !Sub 'aws eks update-kubeconfig --region ${AWS::Region} --name ${ClusterName}'
